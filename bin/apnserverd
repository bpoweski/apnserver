#!/usr/bin/env ruby
require 'getoptlong'
require 'rubygems'
require 'apnserver'
require 'daemons'

def usage
  puts "Usage: apnserverd [switches] --pem <path>"
  puts " --bind-address [0.0.0.0]             bind address of proxy"
  puts " --proxy-port [22195]                 port proxy listens on"
  puts " --server <gateway.push.apple.com>    the apn server to send messages to"
  puts " --port <2195>                        the port of the apn server"
  puts " --help                               this message"
end

opts = GetoptLong.new(
  ["--bind-address", "-b", GetoptLong::REQUIRED_ARGUMENT],
  ["--proxy-port", "-P", GetoptLong::REQUIRED_ARGUMENT],
  ["--server", "-s", GetoptLong::REQUIRED_ARGUMENT],
  ["--port", "-p", GetoptLong::REQUIRED_ARGUMENT],
  ["--pem", "-c", GetoptLong::REQUIRED_ARGUMENT],
  ["--help", "-h", GetoptLong::NO_ARGUMENT]
)

bind_address = '0.0.0.0'
proxy_port = 22195
server = 'gateway.push.apple.com'
port = 2295
pem = nil

opts.each do |opt, arg|
  case opt
  when '--help'
    usage
  when '--bind-address'
    bind_address = arg
  when '--proxy-port'
	proxy_port = arg.to_i
  when '--server'
  	server = arg
  when '--port'
  	port = arg
  when '--pem'
    pem = arg
  end
end

if pem.nil?
  usage
else
  # Become a daemon
  Daemons.daemonize

  server = ApnServer::Server.new(pem, bind_address, proxy_port)
  server.start!
end